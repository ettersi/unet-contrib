<!DOCTYPE html>
<html class='no-js' lang=''>

<head>
  <meta charset='utf-8'>
  <meta http-equiv='x-ua-compatible' content='ie=edge'>
  <title>Unet | Configurations</title>
  <meta name='description' content=''>
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <link rel='icon' type='image/x-icon' href='/img/unet.ico'>
  <link rel='stylesheet' href='/css/vendor/vendor.css'>
  <link rel='stylesheet' href='/css/vendor/app-orange.css'>
  <link rel='stylesheet' href='/css/vendor/font.css'>
  <link rel='stylesheet' href='/css/style.css'>
  <link rel='stylesheet' href='/css/vendor/fontawesome.css' />
  <script src="/js/vendor/jquery/jquery-3.2.1.min.js"></script> 
  <script src='/js/vendor/vendor/vendor.js' ></script>
  <style>
    :root{
      --grey-color:#4f5f6f;
      --label-color:rgba(0, 0, 0, 0.5);
      --border-color:rgba(0, 0, 0, 0.2);
    }

    .item{
      padding: 0.4rem;
    }

    .item a{
      text-decoration: none;
    }

    .borderless td, .borderless th {
      border: none;
    }

    .label,.fa.fa-question-circle{
      color: var(--label-color);
    }

    [contenteditable]:focus {
      outline: 1px solid var(--border-color);
    }

    .show-btn{
      padding: 0 0.175rem;
    }

    .toast{
      background-color:#FFF;
      opacity: 1;
    }
    .table th, .table td{
      padding: 0.25rem
    }
    .abtn{
      padding-top:0;
      padding-bottom: 0;
    }
    .title.section-title{
      font-size: 1rem;
      padding-top: 1rem;
    }
    .help{
      width:3px;
    }
    .popover-body{
      background-color:#e6f9ff;
      white-space: pre;
      display: inline-block;
    }
    .no-param{
      font-style:italic;text-align:center;width:100%;
    }
    .param-value{
      text-align: right;
      font-size: 0.9rem;
    }
    .label{
      font-size: 0.9rem
    }
  </style>
</head>
<body>
  <div class='main-wrapper'>
    <div class='app header-fixed footer-fixed sidebar-fixed' id='app'>
      <article class='content dashboard-page'>
        <h1>Modem Configuration</h1><hr>
        <section class='section'>
          <div class='row'>
            <div class='col-md-4'>
              <div class='card'>
                <div class='card-header bordered'>
                  <div class='header-block'>
                    <h3 class='title'> Currently loaded agents </h3>
                  </div>
                </div>
                <div class='card-block'>
                  <section class='example'>
                    <ul class='item-list' id='agents-table'>
                      <template id='agent-tmpl'>
                        <li class='item' style='flex-direction: row'> 
                          <button class='btn abtn' id='agent-help' data-toggle='popover' data-placement='right' data-boundary='window'><i class='fa fa-question-circle'></i></button>
                          <a href='#' data-toggle='pill' role="tab" aria-selected="true"></a>
                        </li>
                      </template>
                    </ul>
                  </section>
                </div>
              </div>
            </div>
            <div class='col-md-8' id='paramtabs'>
              <div class="tab-content" id="v-pills-tabContent">
                <template id="param-tmpl">
                  <div class='tab-pane fade show active' role='tabpanel'>
                    <div class='card'>
                      <div class='card-header'>
                        <div class='header-block'>
                          <h2 class='title'> </h2>
                          <p class='title-description'></p>
                        </div>
                        <div class='header-block pull-right'>
                          <button class='btn btn-sm rounded pull-right' id='close'>
                            <i class='fa fa-times' style='color:var(--grey-color)'></i>
                          </button>
                        </div>
                      </div>
                      <div class='card-block'>
                        <div class="table-responsive-lg">
                          <table class='table borderless' id='paramform'>
                            <tbody id='params'>
                            </tbody>
                          </table>
                        </div>
                     </div>
                   </div>
                 </div>
               </template>
               <template id='paramform-tmpl'>
                <tr>
                  <td class='help'>
                    <button class='btn abtn' id='help-btn' data-toggle='popover' data-placement='bottom' data-boundary='window'>
                      <i class='fa fa-question-circle'></i></button>
                  </td>
                  <td class='param-name'></td>
                  <td class='param-value'></td>
                  <td class='param-set'>
                    <input style="text-align:right;" type="text" size="8" >
                    <button class="btn btn-secondary abtn">Set</button>
                  </td>
                </tr>
              </template>
            </div>
          </div>
          <div class='col-md-3'>
            <div class="toast" role="alert" aria-live="assertive" aria-atomic="true" hidden>
              <div class="toast-body">
                <button type="button" class="ml-2 mb-1 close pull-right" data-dismiss="toast" aria-label="Close" id='close-toast'>
                  <span aria-hidden="true">&times;</span>
                </button>
                <span id='valmsg'></span>
              </div>
            </div>
            <div id='help' class="alert alert-light alert-dismissible fade show" role="alert" hidden>
              <p class='title-description'></p>
              <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
          </div>
        </section>
      </article>
    </div>
  </div>
</body>
<script type='module'>
  import '/js/webif.js';
  import { Gateway, Performative, MessageClass } from '/js/unet.js';

  const avgtime = 10000;

  var gw = new Gateway();
  var agentDetails = [],agents;
  var websh = gw.agent('websh')

  var ParameterReq = MessageClass('org.arl.unet.ParameterReq');
  var ParameterRsp = MessageClass('org.arl.unet.ParameterRsp');
  var ShellExecReq = MessageClass('org.arl.fjage.shell.ShellExecReq');

  var agentTmpl, paramTmpl,paramFormTmpl;

  window.addEventListener('load',async function(){
    agentTmpl = document.getElementById('agent-tmpl');
    paramTmpl = document.getElementById('param-tmpl');
    paramFormTmpl = document.getElementById('paramform-tmpl');
    agents = await makeRq(websh);
    // console.log('agents: '+JSON.stringify(agents))
    agents.sort(function(a,b){
      if(a.name == 'websh') return;
      return a.title.localeCompare(b.title);  
    })
    // console.log('agents: '+JSON.stringify(agents.splice(0,agents.length)))
    displayAgents();
  });

  /**
   * To display the list of agents and the related details
   */
   function displayAgents(){
    let agentTable = document.getElementById('agents-table');
    agents.forEach((agent,idx)=>{
      if(!agent || !agent.title) return
      let clone = document.importNode(agentTmpl.content,true);
      let cells = clone.querySelector('li');
      let acell = cells.getElementsByTagName('a')[0];
      acell.id = agent.name + '-param-tab';
      acell.href = '#'+agent.name + '-param';
      acell.innerHTML = agent.title;
      acell.setAttribute('aria-controls',agent.name + '-param')
      setAgentListener(acell,agent);
      let helpBtn = cells.querySelector('#agent-help');
      setHelpListeners(helpBtn,null,agent);
      agentTable.appendChild(clone);
    })
  }

  /**
   * To set event listener for the agent Id links
   */
   function setAgentListener(elem,agent){
    let paramTab = document.getElementById('v-pills-tabContent');
    let params,divTab;
    elem.addEventListener('click',async function(){
      let res = await paramReq(agent.name,-1);
      let found = res.agentDetails.filter((elem)=>{
        return elem.name == agent.name;
      })
      // var i = 1
      // do {
      //   res = await paramReq(agent.name, i);
      //   i++
      // } while (res.paramListLength != 0)
      params = found[0].paramList;
      let exists = document.getElementById(agent.name+'-param');
      if(exists) return;
      let clone = document.importNode(paramTmpl.content,true);
      divTab = clone.querySelector('.tab-pane');
      divTab.id = agent.name + '-param';
      divTab.setAttribute('aria-labelledby',agent.name + '-param-tab')
      let title = divTab.querySelector('h2');
      title.innerHTML = agent.title;
      let agentClass = divTab.querySelectorAll('p')[0];
      agentClass.innerHTML = agent.description;
      paramTab.appendChild(clone);
      let closeBtn = divTab.querySelector('#close');
      if(closeBtn){
        closeBtn.addEventListener('click',function(ev){
          var tabElem = document.getElementById(agent.name+'-param');
          tabElem.parentNode.removeChild(tabElem);
          let popvrElems = document.querySelectorAll('.popover');
          for(let pop of popvrElems){
            $(this).popover('hide');
          }
        })
      }
      var paramClasses = {}
      if(params){
        params.forEach( p => {
          if(p.paramClassName in paramClasses){
            paramClasses[p.paramClassName].push(p);
          }else{
            paramClasses[p.paramClassName] = [p];
          }
        });
      }
      displayParams(paramClasses,divTab,agent);
    })
  }

  /**
   * To display the parameters and values in the new tab
   */
   function displayParams(paramClasses,divTab,agent){
    let paramForm = divTab.querySelector('#params');
    let nextParamGrp;
    let grpLen=0;
    if(!paramClasses){
      let clone = document.importNode(paramFormTmpl.content,true);
      let cells = clone.querySelectorAll('td');
      cells[0].innerHTML = 'No configurable parameters';
      cells[0].setAttribute('colspan','2');
      cells[0].setAttribute('class','no-param title-description');
      paramForm.appendChild(clone);
      document.querySelector('#'+divTab.id+ ' #edit-info').hidden=true;
      return
    }
    for (let paramClassName in paramClasses){
      let params = paramClasses[paramClassName];
      let clone = document.importNode(paramFormTmpl.content,true);
      let row = clone.querySelector('tr');
      let thElem = document.createElement('th');
      thElem.classList.add('title','section-title');
      thElem.innerHTML = paramClassName;
      thElem.setAttribute('colspan','3');
      row.parentNode.insertBefore(thElem,row);

      params.forEach(param => {
        console.log('param: '+JSON.stringify(param));
        let clone = document.importNode(paramFormTmpl.content,true);
        let cells = clone.querySelectorAll('td');
        cells[1].innerHTML = param.paramName;
        if(param.paramValue && param.paramValue.data)
          cells[2].innerHTML = param.paramValue.data;
        else{
          cells[2].innerHTML = param.paramValue;
        }
        cells[2].id = param.paramName;
        cells[2].dataset.paramName = param.paramName;

        setParamListeners(cells[3].children[1],param,agent);
        let helpBtn = cells[0].querySelector('#help-btn');
        setHelpListeners(helpBtn,param,agent);
        paramForm.appendChild(clone);
      })
    }
  }

  /**
   * To set event listeners on change of parameter values
   */
  function setParamListeners(setBtn,param,agent){
    setBtn.addEventListener('click', () =>{
      saveParam(setBtn,param,agent);
    });
  }

  function parseValue(val){
    if (val == 'true') return true;
    if (val == 'false') return false;
    if (parseFloat(val) != NaN) return parseFloat(val);
    return val;
  }

  /**
   * To save the modified parameter values
   */
  async function saveParam(setBtn,param,agent){
    let tdElem = setBtn.parentNode;
    let aid = gw.agent(agent.name);
    setBtn.disabled = true;
    tdElem.firstElementChild.disabled = true;
    let rsp = await aid.set(param.paramName,parseValue(tdElem.firstElementChild.value));
    if (!rsp){
      console.warn('Error in setting param:'+'|'+aid);
    }else{
      tdElem.parentNode.children[2].innerHTML = rsp.toString()
      tdElem.firstElementChild.value = '';
    }
    setBtn.disabled = false;
    tdElem.firstElementChild.disabled = false;
  }

  /**
   * To set event listeners for the help icons
   */
  function setHelpListeners(helpBtn,helpParam,helpAgent){
    let helpDtls;
    helpBtn.addEventListener('click',async function(){
      if(helpParam) helpDtls = await getHelp(helpAgent.name, helpParam.paramName)
      else helpDtls = await getHelp(helpAgent.name, null)
      let helpRow = helpDtls.find(item=> {
        if(helpParam) return item.paramName == helpParam.paramName
          else return item.name == helpAgent.name
        });
      let helpText = helpRow.help;
      if(!helpText) return
      helpBtn.dataset.content=helpText.slice(helpText.indexOf('-')+1);
      $("[data-toggle=popover]").popover('show',{
        trigger:'focus hover'
      })
      .blur(function () {
        $(this).popover('hide');
      });
      let popover = document.querySelector('.popover-body');
      if(popover) $("[data-toggle=popover]").popover('toggle');
    })
  }

  function makeRq(shell) {
    return new Promise(async resolve=>{
      let req = new ShellExecReq();
      req.recipient = shell;
      req.cmd = 'ps();';
      req.ans = true;
      gw.request(req).then(async (msg) => {
      let res= await parseRsp(msg.ans);
      resolve(agentDetails);
    }).catch((ex) => {
      console.warn('Could not execute command: '+ex);
    });
  })
  }

  function parseRsp(ps) {
    var agentList = ps.split("\n");
    let promise = [];
    for (var i = 0; i < agentList.length; i++) {
      var j = agentList[i].split(/ ?[\-:] /)
      if (j[1] != "REMOTE") {
        promise.push(getTitle(j[0],j[1]));
    }
  }
  return Promise.all(promise);
}

function getTitle(name,agentCls) {
  return new Promise(resolve=>{
    let req = new ParameterReq()
    req.recipient = gw.agent(name)
    req.index = -1
    req.param = 'title'
    var sp = {}
    gw.request(req).then( rsp => {
      if (rsp.perf == Performative.INFORM) {
        sp.name = name
        sp.title = rsp.value
        sp.class = agentCls
        agentDetails.push(sp)

      }
      resolve();
    })
  })
}

function getIndex(list, name) {
  var foundObject = list.find(function(element) { 
    return element.name == name
  });

  var foundIndex = list.findIndex(function(element, index) { 
    return element === foundObject
  });

  return foundIndex;
}

function paramReq(name,index) {
  return new Promise(resolve=>{
  
  var foundIndex = getIndex(agentDetails, name)

  let req = new ParameterReq()
  req.recipient = name
  req.index = index;
  gw.request(req, 1000).then((rsp) => {
    if (rsp.perf == Performative.INFORM) {
      var specificParamList = []
      if (rsp.values) {
        rsp.values[rsp.param]=rsp.value
        for (var i = 0; i < Object.keys(rsp.values).length; i++) {
          var sp = {}
          if (Object.keys(rsp.values)[i] != 'title' && Object.keys(rsp.values)[i] != 'description') {
            sp.paramClassFullName = Object.keys(rsp.values)[i]
            sp.paramValue = Object.values(rsp.values)[i]
            var x = Object.keys(rsp.values)[i].split(".")
            sp.paramName = x.pop()
            sp.paramClassName = x.pop()
            specificParamList.push(sp)
          }
          else if (Object.keys(rsp.values)[i] == 'title') {
          // agentDetails[foundIndex].title = Object.values(rsp.values)[i]
          // Skipping since we populate title initially
        }
        else if (Object.keys(rsp.values)[i] == 'description') {
          agentDetails[foundIndex].description = Object.values(rsp.values)[i]
        }
      }

      var p = 'paramList'
      if (specificParamList.length != 0) {
        if (index > 0) {
          p = 'paramList'+index
        }
        agentDetails[foundIndex][p] = specificParamList
      }

    }        
  }
  var ret = {}
  ret.agentDetails=agentDetails
  ret.paramListLength=specificParamList.length
  // console.log(agentDetails)
  resolve(ret);
})
})
}

function getHelp(name, paramName) {
  return new Promise(resolve=>{
    let req = new ShellExecReq()
    if (paramName != null) {
      var helpToken = 'help(\''+name+'.'+paramName+'\');'
    }
    else {
      var helpToken = 'help(\''+name+'\');'
    }
    
    req.recipient = gw.agent('websh')
    req.cmd = helpToken
    req.ans = true
    gw.request(req).then(async (msg) => {
      if (paramName != null) {
        var pList = agentDetails[getIndex(agentDetails, name)].paramList
        for (var i = 0; i < pList.length; i++) {
          if (pList[i].paramName == paramName) {
            pList[i].help = msg.ans
            break;
          }
        }
        resolve(pList);
      }
      else {
        agentDetails[getIndex(agentDetails, name)].help=msg.ans
        resolve(agentDetails);
      }
    }).catch((ex) => {
      console.warn('Could not execute command: '+ex);
    });
  })
  }
</script>
</html>
